# TCPIPDemo
Notes about TCPIP

趣谈网络协议：https://time.geekbang.org/column/85

7层协议图解：https://www.cnblogs.com/wanghuaijun/p/10092930.html

NS3路由模拟实验：https://blog.csdn.net/qq_39564555/article/details/98471596

## 1. 概述
### 1.1 分层
>网络协议通常分不同层次进行开发，每一层分别负责不同的通信功能。一个协议族，比如TCP/IP，是一组不同层次上的多个协议的组合，TCP/IP协议通常被认为是一个四层协议系统：

![image](https://user-images.githubusercontent.com/34849140/143688228-e51c3229-4be1-48d1-a784-c5119e653217.png)
- **链路层**也称为数据链路层或网络接口层，和系统中的设备驱动程序以及计算机中的网络接口卡一起处理与电缆的物理接口细节。
- **网络层**负责处理分组在网络中的活动，例如分组的选路。它包括IP网际协议、ICMP Internet互联网控制报文协议以及IGMP Internet组管理协议。
- **运输层**为两台主机上的应用程序提供端到端的通信，该协议族中有两个传输协议：**TCP传输控制协议**和**UDP用户数据报协议**，两者都是**以IP作为网络层协议**。
  - **TCP**为两台主机提供可靠请的数据通信，把应用程序交给它的数据分成合适的小块交给下面的网络层。TCP在不可靠的IP层上提供了一个可靠的运输层。为了提供这种可靠的服务，TCP采用了超时重传、发送和接收端到端的确认分组等机制。本书的17~22章节会详细讨论TCP的内部如何以不可靠的IP服务来提供一种可靠的运输层服务的细节。
  - **UDP**为应用层提供非常简单的服务，只是把称作数据报的分组从一台主机发送到另一台主机，不保证该数据报能到达另一端，可靠性由应用层来提供。本书的第11章讨论UDP、14章DNS、15章TFTP简单文本传输协议以及16章的BOOTP，介绍使用UDP的应用程序。SNMP也使用了UDP协议，放在了25章。
- **应用层**负责处理特定的应用程序细节，各种不同的TCP/IP协议族实现都会提供Telnet、SNMP等应用协议。
>网络层与运输层之间的区别似乎不是那么明显，为什么要把它们划分成两个不同的层次呢？这就要从**单个网络扩展到一组网络**说起。

![image](https://user-images.githubusercontent.com/34849140/143689177-249e2a3b-314e-4628-a61f-0261fa4a700a.png)

80年代，为了连接相同协议族却又孤立的系统组在一起形成互连网络，最简单的办法就是通过**路由器**进行连接，它的好处是为不同类型的物理网络提供连接：以太网、令牌环网以及点对点的链接等等。连接网络的另一个途径是使用网桥。**网桥是在链路层上对网络进行互连，而路由器则是在网络层上对网络进行互连**。网桥使得多个局域网LAN组合在一起，使其对上层来说就像一个局域网。

![123](https://user-images.githubusercontent.com/34849140/143690010-551a543e-f741-4455-a216-d46c01be3ef1.png)

>TCP/IP倾向于使用路由器而非网桥来连接网络，本书中着重介绍路由器。

**ICMP**是IP协议的附属协议，IP层用它来与其他主机或路由器交换错误和其他重要信息。它也可以被应用程序访问，7、8章节会介绍两个流行诊断工具Ping和Traceroute。

**IGMP**是Internet组管理协议，它用来把一个UDP数据报多播到多个主机，12章中会描述广播（把UDP数据报发送到某个指定网络上的所有主机）的特性。

**ARP和RARP**地址解析协议、逆地址解析协议是某些**网络接口**使用的特殊协议，用来转换IP层和网络接口层使用的地址，4、5章节会进行分析和介绍。

![image](https://user-images.githubusercontent.com/34849140/143726853-89e2aba4-9545-4ffa-9121-43aec82270ae.png)

### 1.2 互联网的地址
互联网上的每个接口必须有一个唯一的Internet地址，也称为IP地址，长32bit。IP地址具有以下5中结构：

![addressstruct](https://user-images.githubusercontent.com/34849140/143731601-5319808d-7a54-49ab-9098-021ac6c4d1f6.png)

负责为接入互联网的网络分配IP地址得管理机构称之为InternetNetworkIC互联网络信息中心，它只负责分配网络号，主机号的分配由系统管理员来负责。
### 1.3 封装
当应用程序用TCP传送数据时，数据被送入协议栈中，然后逐个通过每一层直到被当作一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部
信息）。TCP传给IP的数据单元称作TCP报文段或简称为TCP段（TCP segment）。IP传给网络接口层的数据单元称作IP数据报(IP datagram)，更准确的说法是分组（package）。**通过以太网传输的比特流称作帧(Frame)**。

![1 7](https://user-images.githubusercontent.com/34849140/143732202-dc286adb-4fc2-400a-ad44-bda9b9dddd02.png)

由于TCP、UDP、ICMP和IGMP都要向IP传送数据，因此IP必须在生成的IP首部中加入某种标识，以表明数据属于哪一层。为此IP在首部中存入一个长度为8 bit的数值，称作协议域。1表示为ICMP协议，2表示为IGMP协议，6表示为TCP协议，17表示为UDP协议。类似地，许多应用程序都可以使用TCP或UDP来传送数据。运输层协议在生成报文首部时要存入一个应用程序的标识符。**TCP和UDP都用一个16 bit的端口号来表示不同的应用程序**。TCP和UDP把源端口号和目的端口号分别存入报文首部中。

### 1.4 分用
>当目的主机收到一个以太网数据帧时，数据就开始从协议栈中由底向上升，同时去掉各层协议加上的报文首部。每层协议盒都要去检查报文首部中的协议标识，以确定接收数据的上层协议。这个过程称作分用（Demultiplexing）。

![image](https://user-images.githubusercontent.com/34849140/143732468-bd74b760-b6bb-4d9e-b042-6b404e403486.png)

为协议ICMP和IGMP定位一直是一件很棘手的事情。之前把它们与IP放在同一层上，那是因为事实上它们是I P的附属协议。但是在这里又把它们放在IP层的上面，这是**因为ICMP和IGMP报文都被封装在IP数据报中**。
对于ARP和RARP，我们也遇到类似的难题。在这里把它们放在以太网设备驱动程序的上方，这是因为**它们和IP数据报一样，都有各自的以太网数据帧类型**。但在之前我们又把ARP作为以太网设备驱动程序的一部分，放在IP层的下面，其原因在逻辑上是合理的。

### 1.5 端口号
>大部分网络应用程序在编写时都假设一端是客户、一端是服务器。服务器一般都通过知名端口号来识别，比如对每个TCP/IP实现来说，FTP服务器的TCP端口号都是21，每个Telnet服务器的TCP端口号都是23。这些知名端口号由Internet号分配机构来管理。客户端通常对它所使用的端口号不关心，只需要保证该端口号（客户端端口号又称为临时端口号）在本机上是唯一的就可以。

### 1.6 应用编程接口
>使用TCP/IP协议的应用程序通常采用两种应用编程接口（API）：socket和TLI（运输层接口：Transport Layer Interface）。前者有时称作“Berkeley socket”，表明它是从伯克利版发展
而来的。后者起初是由AT & T开发的。

### 1.7 测试网络
本书中所有例子运行的测试网络：

![image](https://user-images.githubusercontent.com/34849140/143771240-42517428-b835-4049-bfc2-0e2c95f5a8d5.png)

## 2. 链路层
>本章中将详细讨论以太网链路层协议，两个串行接口链路层协议SLIP和PPP以及大多数实现都包含的环回驱动程序。以太网和SLIP是本书中大多数例子使用的链路层。

### 2.1 以太网链路层协议
>以太网是当今TCP/IP采用的主要局域网技术，它采用一种称作为**CSMA/CD（带冲突检测的载波侦听多路接入方法**的媒体接入方法。
- IEEE 802委员会公布了一个稍有不同的标准集，其中802.3针对整个CSMA/CD网络，802.4针对令牌总线网络，802.5针对令牌环网络。这三者的共同特性由802.2标准来定义，那就是802网络共有的逻辑链路控制LLC。IEEE 802网络的IP数据报封装是在RFC 1042[Postel and Reynolds 1988]中定义的。
- 在TCP/IP世界中，以太网IP数据报的封装是在RFC 894[Hornig 1984]中定义的。
两种帧格式都采用48 bit的目的地址和源地址（802.3允许使用16 bit的地址，但一般是48 bit地址），这就是我们在本书中所称的**硬件地址**。

![image](https://user-images.githubusercontent.com/34849140/143891031-b7e9e27b-8528-4f84-a70e-dd1cc6f457af.png)

其中的`CRC字段`用于帧内后续字节差错的循环冗余码检验（检验和）（它也被称为FCS或帧检验序列）。

### 2.2 SLP全称为串行线路IP
>它是对串行线路上对IP数据报进行封装的简单形式，适用于家庭中每台计算机几乎都有的RS-232串行端口和高速调制解调器接入Internet。
下面的规则描述了S L I P协议定义的帧格式：
- IP数据报以一个称作END（0xc0）的特殊字符结束。同时，为了防止数据报到来之前的线路噪声被当成数据报内容，大多数实现在数据报的开始处也传一个END字符（如果有线路噪声，那么END字符将结束这份错误的报文。这样当前的报文得以正确地传输，而前一个错误报文交给上层后，会发现其内容毫无意义而被丢弃）。
- 如果IP报文中某个字符为END，那么就要连续传输两个字节0xdb和0xdc来取代它。0xdb这个特殊字符被称作SLIP的ESC字符，但是它的值与ASCII码的ESC字符（0x1b）不同。
- 如果IP报文中某个字符为SLIP的ESC字符，那么就要连续传输两个字节0xdb和0xdd来取代它。
下图的例子就是含有一个END字符和一个ESC字符的IP报文。在这个例子中，在串行线路上传输的总字节数是原IP报文长度再加4个字节。

![image](https://user-images.githubusercontent.com/34849140/143899626-b8c66d69-62bf-4628-9e9c-9c74dc6f6e8f.png)

SLIP有一些缺点是：
- 数据帧中没有类型字段，如果一条串行线路用于SLIP那么它不能同时使用其他协议。
- SLIP没有在数据帧中加上检验和（类似于以太网中的CRC字段）。如果SL P传输的报文被线路噪声影响而发生错误，只能通过上层协议来发现（另一种方法是，新型的调制解调器可以检测并纠正错误报文）。这样，上层协议提供某种形式的CRC就显得很重要。在第3章和第17章中，我们将看到IP首部和TCP首部及其数据始终都有检验和。在第11章中，将看到UDP首部及其数据的检验和却是可选的。

### 2.3 PPP点对点协议
### 2.4 环回接口
大多数的产品都支持环回接口（Loopback Interface），以允许运行在同一台主机上的客户程序和服务器程序通过TCP/IP进行通信。A类网络号127就是为环回接口预留的。根据惯例，大多数系统把IP地址127.0.0.1分配给这个接口，并命名为localhost。一个传给环回接口的IP数据报不能在任何网络上出现。
### 2.5 MTU最大传输单元
以太网和802.3对数据帧的长度都有一个限制，其最大值分别是1500和1492字节。链路层的这个特性称作MTU，最大传输单元。不同类型的网络大多数都有一个上限。如果IP层有一个数据报要传，而且数据的长度比链路层的MTU还大，那么IP层就需要进行分片（fragmentation），把数据报分成若干片，这样每一片都小于MTU。我们将在11.5节讨论`IP分片的过程`。
